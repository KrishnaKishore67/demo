<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Participant Listener</title>
  <style>
    body { background: #1a1a1a; color: #fff; font-family: sans-serif; text-align: center; }
    canvas { width: 90%; height: 150px; background: #000; border: 1px solid #444; margin: 20px 0; }
    .log-container { background: #000; color: #00ff00; text-align: left; padding: 15px; height: 200px; overflow-y: auto; font-family: monospace; border: 1px solid #00ff00; margin: 20px auto; width: 80%; }
    input { padding: 10px; font-size: 18px; width: 250px; }
    button { padding: 10px 20px; font-size: 18px; background: #00ff00; border: none; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>
  <h1>PARTICIPANT APP</h1>
  <input id="bib" type="number" placeholder="Enter Bib Number" />
  <button id="listenBtn">START SCANNING</button>
  
  <canvas id="visualizer"></canvas>
  <div id="status">READY</div>
  <div class="log-container" id="log">--- CHECKPOINT LOGS ---</div>

  <script>
    let audioCtx, analyser, dataArray, canvas, canvasCtx;
    const knownFrequencies = { "CP1": [15500, 16000, 16500] };
    let lastLogTime = 0;

    document.getElementById("listenBtn").addEventListener("click", async () => {
      const bib = document.getElementById("bib").value;
      if (!bib) return alert("Enter Bib Number!");

      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
      });

      audioCtx = new AudioContext();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 4096; // High resolution
      const source = audioCtx.createMediaStreamSource(stream);
      source.connect(analyser);

      dataArray = new Uint8Array(analyser.frequencyBinCount);
      
      // Setup Visualizer
      canvas = document.getElementById("visualizer");
      canvasCtx = canvas.getContext("2d");
      
      document.getElementById("status").innerText = "LISTENING...";
      detect(bib);
    });

    function detect(bib) {
      analyser.getByteFrequencyData(dataArray);
      drawVisualizer();

      const nyquist = audioCtx.sampleRate / 2;
      const avgNoise = dataArray.reduce((a, b) => a + b) / dataArray.length;
      const threshold = avgNoise + 50; // Dynamic sensitivity

      for (let cp in knownFrequencies) {
        let hits = 0;
        knownFrequencies[cp].forEach(freq => {
          const index = Math.round(freq / nyquist * dataArray.length);
          // Check peak at index and neighbors
          const val = Math.max(dataArray[index], dataArray[index-1] || 0, dataArray[index+1] || 0);
          if (val > threshold && val > 100) hits++;
        });

        if (hits >= 2 && (Date.now() - lastLogTime > 8000)) {
          lastLogTime = Date.now();
          logSuccess(cp, bib);
        }
      }
      requestAnimationFrame(() => detect(bib));
    }

    function drawVisualizer() {
      canvasCtx.fillStyle = "black";
      canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
      canvasCtx.strokeStyle = "#00ff00";
      canvasCtx.beginPath();
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] / 255.0;
        const y = canvas.height - (v * canvas.height);
        if (i === 0) canvasCtx.moveTo(x, y);
        else canvasCtx.lineTo(x, y);
        x += sliceWidth;
      }
      canvasCtx.stroke();
    }

    function logSuccess(cp, bib) {
      document.getElementById("status").innerText = "!!! CHECKPOINT MATCHED !!!";
      document.getElementById("status").style.color = "#00ff00";
      
      const time = new Date().toLocaleTimeString();
      const entry = `\n[${time}] BIB ${bib} reached ${cp}`;
      document.getElementById("log").innerText += entry;

      setTimeout(() => {
        document.getElementById("status").innerText = "LISTENING...";
        document.getElementById("status").style.color = "white";
      }, 3000);
    }
  </script>
</body>
</html>
